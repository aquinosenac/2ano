<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Gerente - Senac Agendamentos</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="painel-container">
    <h1>Painel do Gerente</h1>

    <section class="secao">
      <h2>üè´ Gerenciar Salas</h2>
      <form id="formSala">
        <input type="text" id="nomeSala" placeholder="Nome da Sala" required>
        <input type="text" id="descricaoSala" placeholder="Descri√ß√£o" required>
        <input type="number" id="capacidadeSala" placeholder="Capacidade" required>
        <button type="submit" class="btn-primary">Adicionar Sala</button>
      </form>
      <div id="lista-salas" class="lista"></div>
    </section>

    <section class="secao">
      <h2>üìÖ Aprovar / Excluir Reservas</h2>
      <div id="reservas-lista" class="lista"></div>
    </section>

    <button id="logout" class="btn-secondary">Sair</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
  const db = firebase.firestore();
  const auth = firebase.auth();

  // ======= SALAS =======
  function carregarSalas() {
    db.collection("salas").onSnapshot(snapshot => {
      const lista = document.getElementById("lista-salas");
      lista.innerHTML = "";
      snapshot.forEach(doc => {
        const s = doc.data();
        const item = document.createElement("div");
        item.classList.add("item");
        item.innerHTML = `
          <strong>${s.nome}</strong> (${s.capacidade} lugares) - ${s.descricao}
          <button onclick="excluirSala('${doc.id}')">Excluir</button>
        `;
        lista.appendChild(item);
      });
    });
  }

  document.getElementById("formSala").addEventListener("submit", async e => {
    e.preventDefault();
    const nome = document.getElementById("nomeSala").value.trim();
    const descricao = document.getElementById("descricaoSala").value.trim();
    const capacidade = parseInt(document.getElementById("capacidadeSala").value);
    await db.collection("salas").add({ nome, descricao, capacidade });
    e.target.reset();
  });

  async function excluirSala(id) {
    await db.collection("salas").doc(id).delete();
  }

  // ======= RESERVAS =======
  function carregarReservas() {
    db.collection("reservas").where("status", "==", "pendente").onSnapshot(snapshot => {
      const container = document.getElementById("reservas-lista");
      container.innerHTML = "";
      if (snapshot.empty) {
        container.innerHTML = "<p>Nenhuma reserva pendente.</p>";
        return;
      }

      snapshot.forEach(doc => {
        const r = doc.data();
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
          <strong>${r.sala}</strong> - ${r.horario}<br>
          ${r.descricao}<br>
          Solicitado por: ${r.nomeUsuario}<br>
          <button onclick="aprovarReserva('${doc.id}')">Aprovar</button>
          <button onclick="excluirReserva('${doc.id}')">Excluir</button>
        `;
        container.appendChild(div);
      });
    });
  }

  async function aprovarReserva(id) {
    await db.collection("reservas").doc(id).update({ status: "aprovada" });
  }

  async function excluirReserva(id) {
    await db.collection("reservas").doc(id).delete();
  }

  // ======= LOGOUT =======
  document.getElementById("logout").addEventListener("click", () => {
    auth.signOut().then(() => window.location.href = "../usu√°rio.html");
  });

  // ======= VALIDA√á√ÉO DE CARGO =======
  auth.onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "../login-cadastro/login.html";
      return;
    }

    const docRef = await db.collection("usuarios").doc(user.uid).get();
    const cargo = docRef.exists ? docRef.data().cargo : null;
    if (cargo !== "gerente" && cargo !== "admin") {
      alert("Acesso negado.");
      window.location.href = "../usu√°rio.html";
      return;
    }

    carregarSalas();
    carregarReservas();
  });
  </script>
</body>
</html>
