<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Administrador - Senac Agendamentos</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="painel-container">
    <h1>Painel do Administrador</h1>

    <!-- === SALAS === -->
    <section class="secao">
      <h2>游낆 Gerenciar Salas</h2>
      <form id="formSala">
        <input type="text" id="nomeSala" placeholder="Nome da Sala" required>
        <input type="text" id="descricaoSala" placeholder="Descri칞칚o" required>
        <input type="number" id="capacidadeSala" placeholder="Capacidade" required>
        <button type="submit" class="btn-primary">Adicionar Sala</button>
      </form>
      <div id="lista-salas" class="lista"></div>
    </section>

    <!-- === RESERVAS === -->
    <section class="secao">
      <h2>游늰 Gerenciar Reservas</h2>
      <div id="reservas-lista" class="lista"></div>
    </section>

    <!-- === USU츼RIOS === -->
    <section class="secao">
      <h2>游녻 Gerenciar Usu치rios</h2>
      <div id="usuarios-lista" class="lista"></div>
    </section>

    <button id="logout" class="btn-secondary">Sair</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
  const db = firebase.firestore();
  const auth = firebase.auth();

  /* === SALAS === */
  function carregarSalas() {
    db.collection("salas").onSnapshot(snapshot => {
      const lista = document.getElementById("lista-salas");
      lista.innerHTML = "";
      snapshot.forEach(doc => {
        const s = doc.data();
        const item = document.createElement("div");
        item.classList.add("item");
        item.innerHTML = `
          <strong>${s.nome}</strong> (${s.capacidade} lugares) - ${s.descricao}
          <button onclick="excluirSala('${doc.id}')">Excluir</button>
        `;
        lista.appendChild(item);
      });
    });
  }

  document.getElementById("formSala").addEventListener("submit", async e => {
    e.preventDefault();
    const nome = document.getElementById("nomeSala").value.trim();
    const descricao = document.getElementById("descricaoSala").value.trim();
    const capacidade = parseInt(document.getElementById("capacidadeSala").value);
    await db.collection("salas").add({ nome, descricao, capacidade });
    e.target.reset();
  });

  async function excluirSala(id) {
    await db.collection("salas").doc(id).delete();
  }

  /* === RESERVAS === */
  function carregarReservas() {
    db.collection("reservas").onSnapshot(snapshot => {
      const container = document.getElementById("reservas-lista");
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const r = doc.data();
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
          <strong>${r.sala}</strong> - ${r.horario}<br>
          ${r.descricao}<br>
          Solicitado por: ${r.nomeUsuario}<br>
          Status: <strong>${r.status}</strong><br>
          <button onclick="atualizarStatus('${doc.id}', 'aprovada')">Aprovar</button>
          <button onclick="atualizarStatus('${doc.id}', 'pendente')">Pendente</button>
          <button onclick="excluirReserva('${doc.id}')">Excluir</button>
        `;
        container.appendChild(div);
      });
    });
  }

  async function atualizarStatus(id, novoStatus) {
    await db.collection("reservas").doc(id).update({ status: novoStatus });
  }

  async function excluirReserva(id) {
    await db.collection("reservas").doc(id).delete();
  }

  /* === USU츼RIOS === */
  function carregarUsuarios() {
    db.collection("usuarios").onSnapshot(snapshot => {
      const lista = document.getElementById("usuarios-lista");
      lista.innerHTML = "";
      snapshot.forEach(doc => {
        const u = doc.data();
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
          <strong>${u.nome || '(sem nome)'}</strong><br>
          ${u.email}<br>
          Cargo atual: <strong>${u.cargo}</strong><br>
          <select id="cargo-${doc.id}">
            <option value="usuario" ${u.cargo === "usuario" ? "selected" : ""}>Usu치rio</option>
            <option value="gerente" ${u.cargo === "gerente" ? "selected" : ""}>Gerente</option>
            <option value="admin" ${u.cargo === "admin" ? "selected" : ""}>Admin</option>
          </select>
          <button onclick="alterarCargo('${doc.id}')">Salvar</button>
          <button onclick="excluirUsuario('${doc.id}')">Excluir</button>
        `;
        lista.appendChild(div);
      });
    });
  }

  async function alterarCargo(uid) {
    const novoCargo = document.getElementById(`cargo-${uid}`).value;
    await db.collection("usuarios").doc(uid).update({ cargo: novoCargo });
    alert("Cargo atualizado com sucesso!");
  }

  async function excluirUsuario(uid) {
    if (confirm("Tem certeza que deseja excluir este usu치rio?")) {
      await db.collection("usuarios").doc(uid).delete();
    }
  }

  /* === LOGOUT === */
  document.getElementById("logout").addEventListener("click", () => {
    auth.signOut().then(() => window.location.href = "../usu치rio.html");
  });

  /* === VERIFICA칂츾O DE ACESSO === */
  auth.onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "../login-cadastro/login.html";
      return;
    }

    const docRef = await db.collection("usuarios").doc(user.uid).get();
    const cargo = docRef.exists ? docRef.data().cargo : null;
    if (cargo !== "admin") {
      alert("Acesso negado. Somente administradores podem acessar esta p치gina.");
      window.location.href = "../usu치rio.html";
      return;
    }

    carregarSalas();
    carregarReservas();
    carregarUsuarios();
  });
  </script>
</body>
</html>
