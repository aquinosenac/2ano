<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade de Hor치rios - RoomZen Senac</title>
    <meta name="description" content="Visualize a disponibilidade de todas as salas em tempo real">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-content">
                <a href="usu치rio.html" class="navbar-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect width="18" height="18" x="3" y="3" rx="2"/>
                        <path d="M9 3v18"/>
                    </svg>
                    <h1 class="navbar-title">Senac Agendamentos</h1>
                </a>
                <div class="navbar-menu">
                    <a href="usu치rio.html" class="navbar-link">In칤cio</a>
                    <a href="salas-horarios.html" class="navbar-link">Grade de Hor치rios</a>
                    <a href="login-cadastro/login.html"><button class="btn-primary">Login</button></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="schedule-section">
  <div class="schedule-container">
    <div class="section-header">
      <h2 class="section-title">Grade de Hor치rios</h2>
      <p class="section-subtitle">Visualize e gerencie as salas e reservas</p>
    </div>

    <div id="acoesGerente" class="acoes-gerente" style="display:none;">
      <h3>丘뙖잺 Painel de Gerenciamento</h3>

      <div class="painel-forms">
        <form id="formSala">
          <input type="text" id="nomeSala" placeholder="Nome da Sala" required>
          <input type="text" id="descricaoSala" placeholder="Descri칞칚o" required>
          <input type="number" id="capacidadeSala" placeholder="Capacidade" required>
          <button type="submit" class="btn-primary">Adicionar Sala</button>
        </form>
      </div>

      <div id="lista-salas" class="lista"></div>

      <div class="painel-reservas">
        <h4>Reservas Pendentes</h4>
        <div id="reservas-lista" class="lista"></div>
      </div>
    </div>

    <div id="calendarWrapper" class="schedule-grid-wrapper"></div>
  </div>
</main>


    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 Senac. Sistema de Gerenciamento de Salas.</p>
        </div>
    </footer>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
const db = firebase.firestore();
const auth = firebase.auth();

let userCargo = null; // ser치 "admin", "gerente" ou "usuario"

// =========================
// 游댳 IN칈CIO DO CALEND츼RIO
// =========================
function gerarCalendario(salas) {
  const horarios = [
    "07:00","08:00","09:00","10:00","11:00",
    "12:00","13:00","14:00","15:00","16:00",
    "17:00","18:00","19:00","20:00","21:00","22:00"
  ];

  let html = `
  <div class="schedule-grid">
    <div class="grid-header">
      <div class="grid-cell header-cell sticky-col">Sala</div>
      ${horarios.map(h => `<div class="grid-cell header-cell">${h}</div>`).join("")}
    </div>
  `;

  salas.forEach(sala => {
    html += `
      <div class="grid-row" data-sala="${sala.nome}">
        <div class="grid-cell room-cell sticky-col">
          <div class="room-name">${sala.nome}</div>
          <div class="room-subtitle">${sala.descricao || ""}</div>
        </div>
        ${horarios.map(h => `<div class="grid-cell time-slot available" title="Dispon칤vel - ${h}"></div>`).join("")}
      </div>
    `;
  });

  html += `</div>`;
  document.getElementById("calendarWrapper").innerHTML = html;
}

function limparCalendario() {
  document.querySelectorAll(".time-slot").forEach(slot => {
    slot.classList.remove("occupied");
    slot.classList.add("available");
    slot.textContent = "";
  });
}

function atualizarReservas(reservas) {
  limparCalendario();

  reservas.forEach(r => {
    const row = document.querySelector(`.grid-row[data-sala="${r.sala}"]`);
    if (!row) return;

    const [inicio, fim] = r.horario.split("-");
    const inicioHora = parseInt(inicio);
    const fimHora = parseInt(fim);

    row.querySelectorAll(".time-slot").forEach(slot => {
      const title = slot.getAttribute("title");
      const horaSlot = parseInt(title.match(/\d+/));
      if (horaSlot >= inicioHora && horaSlot < fimHora) {
        slot.classList.remove("available");
        slot.classList.add("occupied");
        slot.textContent = r.descricao;
        slot.title = `Reservado por ${r.nomeUsuario}`;
      }
    });
  });
}

// =========================
// 游댳 GERENCIAMENTO DE SALAS
// =========================
function carregarSalas() {
  db.collection("salas").onSnapshot(snapshot => {
    const salas = [];
    const listaDiv = document.getElementById("lista-salas");
    listaDiv.innerHTML = "";

    snapshot.forEach(doc => {
      const data = doc.data();
      salas.push(data);

      const item = document.createElement("div");
      item.classList.add("item");
      item.innerHTML = `
        <strong>${data.nome}</strong> (${data.capacidade}) - ${data.descricao}
        ${(userCargo === "admin" || userCargo === "gerente") ?
          `<button onclick="excluirSala('${doc.id}')">Excluir</button>` : ""}
      `;
      listaDiv.appendChild(item);
    });

    gerarCalendario(salas);
    carregarReservas(); // atualiza as reservas sobre o novo grid
  });
}

async function excluirSala(id) {
  await db.collection("salas").doc(id).delete();
}

document.getElementById("formSala").addEventListener("submit", async e => {
  e.preventDefault();
  const sala = {
    nome: document.getElementById("nomeSala").value,
    descricao: document.getElementById("descricaoSala").value,
    capacidade: parseInt(document.getElementById("capacidadeSala").value)
  };
  await db.collection("salas").add(sala);
  e.target.reset();
});

// =========================
// 游댳 RESERVAS
// =========================
function carregarReservas() {
  db.collection("reservas").where("status", "==", "aprovada").onSnapshot(snap => {
    const reservas = [];
    snap.forEach(doc => reservas.push(doc.data()));
    atualizarReservas(reservas);
  });

  if (userCargo === "admin" || userCargo === "gerente") {
    db.collection("reservas").where("status", "==", "pendente").onSnapshot(snap => {
      const lista = document.getElementById("reservas-lista");
      lista.innerHTML = "";
      snap.forEach(doc => {
        const r = doc.data();
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
          <strong>${r.sala}</strong> - ${r.horario}<br>
          ${r.descricao}<br>
          Solicitado por: ${r.nomeUsuario}<br>
          <button onclick="aprovarReserva('${doc.id}')">Aprovar</button>
          <button onclick="excluirReserva('${doc.id}')">Excluir</button>
        `;
        lista.appendChild(div);
      });
    });
  }
}

async function aprovarReserva(id) {
  await db.collection("reservas").doc(id).update({ status: "aprovada" });
}

async function excluirReserva(id) {
  await db.collection("reservas").doc(id).delete();
}

// =========================
// 游댳 LOGIN E PERMISS칏ES
// =========================
auth.onAuthStateChanged(async user => {
  if (user) {
    const userDoc = await db.collection("usuarios").doc(user.uid).get();
    userCargo = userDoc.exists ? userDoc.data().cargo : "usuario";
    console.log(`游녻 Usu치rio logado como ${userCargo}`);

    if (userCargo === "admin" || userCargo === "gerente") {
      document.getElementById("acoesGerente").style.display = "block";
    }
    carregarSalas();
  } else {
    userCargo = null;
    document.getElementById("acoesGerente").style.display = "none";
    carregarSalas();
  }
});
</script>



</body>
</html>