<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerente - TechTrust</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="auth.js"></script>
</head>
<body>

<header>
  <div class="container header-content">
    <a href="home.html" class="logo">TechTrust</a>
    <nav id="navMenu">
      <a href="home.html" class="btn btn-ghost">Home</a>
      <a href="produtos.html" class="btn btn-ghost">Produtos</a>

      <a href="carrinho.html" class="btn btn-primary cart-btn" style="position:relative;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.6 13.59a2 2 0 0 0 2 1.41h9.72a2 2 0 0 0 2-1.72L23 6H6"></path>
        </svg>
        <span class="cart-badge" style="display:none;">0</span>
      </a>
    </nav>
  </div>
</header>

<main class="container" style="padding:2rem 0;">
  
  <h1 style="margin-bottom:1rem;">Painel do Gerente</h1>
  <p style="color:var(--text-light); margin-bottom:2rem;">Gerencie produtos cadastrados</p>

  <!-- Formulário -->
  <div class="admin-form">
    <h2 id="productFormTitle">Adicionar Produto</h2>
    <button id="cancelEdit" class="btn btn-ghost" style="display:none; margin-bottom:1rem;" onclick="resetForm()">Cancelar edição</button>

    <form id="productForm">

      <div class="form-group">
        <label>Nome</label>
        <input id="p_name" required />
      </div>

      <div class="form-group">
        <label>Categoria</label>
        <input id="p_category" required />
      </div>

      <div class="form-group">
        <label>Preço</label>
        <input id="p_price" type="number" step="0.01" required />
      </div>

      <div class="form-group">
        <label>Estoque</label>
        <input id="p_stock" type="number" required />
      </div>

      <div class="form-group">
        <label>Imagem (URL)</label>
        <input id="p_image" />
      </div>

      <div class="form-group">
        <label>Descrição</label>
        <textarea id="p_description"></textarea>
      </div>

      <div class="checkbox-group">
        <input id="p_featured" type="checkbox">
        <label for="p_featured">Produto em destaque</label>
      </div>

      <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">
        <span id="btnText">Adicionar Produto</span>
      </button>

    </form>
  </div>

  <h2 style="margin-top:2rem;">Produtos cadastrados</h2>
  <div id="productsList"></div>

</main>

<div id="notification" class="hidden"></div>

<footer>
  <div class="container"><p>&copy; 2025 TechTrust</p></div>
</footer>

<script src="js/storage.js"></script>

<script>
let editingId = null;

function notify(msg, type='success', time=3000){
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.className = type;
  n.classList.remove("hidden");
  setTimeout(()=> n.classList.add("hidden"), time);
}

async function loadProducts(){
  const list = await firebaseApi.listProductsFirestore();
  const div = document.getElementById("productsList");

  if (!list.length){
    div.innerHTML = "<p style='color:var(--text-light); margin-top:1rem;'>Nenhum produto cadastrado.</p>";
    return;
  }

  div.innerHTML = list.map(p => `
    <div class="admin-product-card">
      <img class="admin-product-image" src="${p.image || 'https://via.placeholder.com/100'}">

      <div class="admin-product-content">
        <h3>${p.name}</h3>
        <p>${p.description || ""}</p>
        <p><strong>R$ ${Number(p.price).toFixed(2)}</strong></p>
        <p>Estoque: ${p.stock}</p>
      </div>

      <div class="admin-product-actions">
        <button class="btn btn-outline" onclick="editProduct('${p.id}')">Editar</button>
        <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">Excluir</button>
      </div>
    </div>
  `).join("");
}

async function saveProduct(e){
  e.preventDefault();

  const data = {
    name: p_name.value,
    category: p_category.value,
    price: Number(p_price.value),
    stock: Number(p_stock.value),
    image: p_image.value || "https://via.placeholder.com/500",
    description: p_description.value,
    featured: p_featured.checked
  };

  if (!editingId){
    await firebaseApi.addProductFirestore(data);
    notify("Produto adicionado!");
  } else {
    await firebaseApi.updateProductFirestore(editingId, data);
    notify("Produto atualizado!");
  }

  editingId = null;
  resetForm();
  loadProducts();
}

async function editProduct(id){
  editingId = id;
  const p = await firebaseApi.getProductByIdFirestore(id);

  p_name.value = p.name;
  p_category.value = p.category;
  p_price.value = p.price;
  p_stock.value = p.stock;
  p_image.value = p.image;
  p_description.value = p.description;
  p_featured.checked = p.featured;

  productFormTitle.textContent = "Editar Produto";
  btnText.textContent = "Salvar Alterações";
  cancelEdit.style.display = "inline-block";
}

function resetForm(){
  editingId = null;
  document.getElementById("productForm").reset();
  productFormTitle.textContent = "Adicionar Produto";
  btnText.textContent = "Adicionar Produto";
  cancelEdit.style.display = "none";
}

async function deleteProduct(id){
  if (!confirm("Excluir este produto?")) return;
  await firebaseApi.deleteProductFirestore(id);
  notify("Produto excluído!");
  loadProducts();
}

// Proteção de rota
document.addEventListener("DOMContentLoaded", async () => {
  const local = JSON.parse(localStorage.getItem("ecommerce_current_user") || "null");

  if (!local) return location.href = "login.html";

  const role = await firebaseApi.getRole(local.uid);
  if (role !== "gerente" && role !== "admin") return location.href = "unauthorized.html";

  loadProducts();

  updateCartCount?.();
});
</script>

</body>
</html>
