<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produtos - TechTrust</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script src="auth.js"></script>
</head>
<body>

<header>
  <div class="container header-content">
    <a href="home.html" class="logo">TechTrust</a>
    <nav id="navMenu">
      <a href="home.html" class="btn btn-ghost">Home</a>
      <a href="login.html" class="btn btn-ghost">Login</a>
      <a href="produtos.html" class="btn btn-primary">Produtos</a>
      <a href="admin.html" class="btn btn-ghost">Admin</a>
      <a href="carrinho.html" class="btn btn-primary cart-btn">
        <span class="cart-badge" style="display:none;">0</span>
      </a>
    </nav>
  </div>
</header>

<div class="container" style="padding-top:2rem; padding-bottom:2rem;">
  <div class="mb-4">
    <h1>Nossos Produtos</h1>
    <p style="color:var(--text-light)">Encontre os melhores produtos de tecnologia</p>
  </div>

  <div class="filters">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input id="searchInput" type="text" placeholder="Buscar produtos..." onkeyup="filterProducts()" />
    </div>

    <div id="categoryButtons" class="filter-buttons"></div>
  </div>

  <div id="resultCount" style="margin-bottom: .5rem; color:var(--text-light);"></div>

  <div id="productsList" class="products-grid"></div>
</div>

<footer>
  <div class="container">
    <p>&copy; 2025 TechTrust. Todos os direitos reservados.</p>
  </div>
</footer>

<script src="js/storage.js"></script>

<script>
/* ---------------- HEADER DINÂMICO ---------------- */
/* ---------------- HEADER DINÂMICO ---------------- */
async function aplicarHeaderDinamico() {
  const nav = document.getElementById("navMenu");
  const user = JSON.parse(localStorage.getItem("ecommerce_current_user") || "null");

  if (!user || !window.firebaseApi) return;

  const role = await firebaseApi.getRole(user.uid);

  nav.innerHTML = `
    <a href="home.html" class="btn btn-ghost">Home</a>
    <a href="produtos.html" class="btn btn-ghost">Produtos</a>

    ${ role === "admin" ? `<a href="admin.html" class="btn btn-ghost">Admin</a>` : "" }
    ${ role === "gerente" ? `<a href="admin.html" class="btn btn-ghost">Gerente</a>` : "" }

    <a href="carrinho.html" class="btn btn-primary cart-btn">
      <span class="cart-badge" style="display:none;">0</span>
    </a>

    <span style="color:var(--text-light); margin-right:1rem;">
        ${user.email} (${role})
    </span>

    <button id="logoutBtn" class="btn btn-outline">Sair</button>
  `;

  document.getElementById("logoutBtn").onclick = async () => {
    await firebaseApi.signOut();
    localStorage.removeItem("ecommerce_current_user");
    window.location.href = "login.html";
  };
}


/* ---------------- CARREGAMENTO DE PRODUTOS ---------------- */
let allProducts = [];
let selectedCategory = "Todas";

async function loadProducts() {
  const wait = setInterval(() => {
    if (window.firebaseApi) {
      clearInterval(wait);
      carregarLista();
    }
  }, 50);
}

async function carregarLista() {
  allProducts = await firebaseApi.listProductsFirestore();

  renderCategories();
  filterProducts();
}

function renderCategories() {
  const categories = ["Todas", ...new Set(allProducts.map(p => p.category || "Outros"))];

  document.getElementById("categoryButtons").innerHTML = categories
    .map(
      c => `
      <button class="btn ${selectedCategory === c ? "btn-primary" : "btn-outline"}"
        onclick="selectCategory('${c}')">
        ${c}
      </button>`
    )
    .join("");
}

function selectCategory(cat) {
  selectedCategory = cat;
  renderCategories();
  filterProducts();
}

function filterProducts() {
  const search = document.getElementById("searchInput").value.toLowerCase();

  let filtered = allProducts;

  if (selectedCategory !== "Todas") {
    filtered = filtered.filter(p => p.category === selectedCategory);
  }

  if (search.trim()) {
    filtered = filtered.filter(p =>
      p.name.toLowerCase().includes(search) ||
      p.description.toLowerCase().includes(search)
    );
  }

  renderProducts(filtered);
}

function renderProducts(list) {
  const box = document.getElementById("productsList");
  const result = document.getElementById("resultCount");

  result.innerHTML = `${list.length} produto(s) encontrado(s)`;

  if (!list.length) {
    box.innerHTML = `<p class="text-center">Nenhum produto encontrado.</p>`;
    return;
  }

  box.innerHTML = list
    .map(
      p => `
      <div class="product-card">
        <div style="position: relative;">
          <img src="${p.image}" class="product-image">

          ${p.featured ? `<span class="badge"></span>` : ""}
          ${p.stock === 0 ? `<span class="badge badge-danger">Esgotado</span>` : ""}
        </div>

        <div class="product-content">
          <span class="product-category">${p.category}</span>

          <h3 class="product-title">${p.name}</h3>
          <p class="product-description">${p.description}</p>

          <div class="product-stock">${p.stock} em estoque</div>

          <div class="product-footer">
            <span class="product-price">R$ ${p.price.toFixed(2)}</span>

            <button class="btn btn-primary"
              onclick='addToCart(${JSON.stringify(p)})'
              ${p.stock === 0 ? "disabled" : ""}>
              Adicionar
            </button>
          </div>
        </div>
      </div>`
    )
    .join("");
}

/* ---------------- INIT ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  const wait = setInterval(() => {
    if (window.firebaseApi) {
      clearInterval(wait);
      aplicarHeaderDinamico();
      loadProducts();
    }
  }, 80);
});
</script>

</body>
</html>
