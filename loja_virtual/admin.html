<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - TechTrust</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="auth.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container header-content">
      <a href="home.html" class="logo">TechTrust</a>
      <nav id="navMenu">
        <a href="home.html" class="btn btn-ghost">Home</a>
        <a href="produtos.html" class="btn btn-ghost">Produtos</a>
        <a href="login.html" class="btn btn-ghost">Login</a>
        <a href="carrinho.html" class="btn btn-primary cart-btn">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.6 13.59a2 2 0 0 0 2 1.41h9.72a2 2 0 0 0 2-1.72L23 6H6"></path>
          </svg>
          <span class="cart-badge" style="display:none; position:absolute; top:-6px; right:-6px; background:var(--accent); color:white; border-radius:50%; padding:2px 6px; font-size:12px;">0</span>
        </a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:2rem 0;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <div>
        <h1 style="font-size:2rem;">Painel Administrativo</h1>
        <p style="color:var(--text-light); margin-top:0.25rem;">Gerencie produtos e usuários</p>
      </div>
      <div id="currentUserInfo" style="color:var(--text-light)">Carregando usuário...</div>
    </div>

    <div class="grid-2">
      <!-- Produtos -->
      <section>
        <div class="admin-form" style="margin-bottom:1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2 id="productFormTitle">Adicionar Produto</h2>
            <button id="cancelProductBtn" class="btn btn-ghost" style="display:none" onclick="resetProductForm()">Cancelar</button>
          </div>

          <form id="productForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="p_name">Nome *</label>
                <input id="p_name" required />
              </div>
              <div class="form-group">
                <label for="p_category">Categoria *</label>
                <input id="p_category" required />
              </div>
              <div class="form-group">
                <label for="p_price">Preço (R$) *</label>
                <input id="p_price" type="number" step="0.01" required />
              </div>
              <div class="form-group">
                <label for="p_stock">Estoque *</label>
                <input id="p_stock" type="number" required />
              </div>
              <div class="form-group" style="grid-column:1 / -1;">
                <label for="p_image">URL da Imagem</label>
                <input id="p_image" />
              </div>
              <div class="form-group" style="grid-column:1 / -1;">
                <label for="p_description">Descrição</label>
                <textarea id="p_description"></textarea>
              </div>
              <div class="form-group checkbox-group">
                <input id="p_featured" type="checkbox" />
                <label for="p_featured">Produto em Destaque</label>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">
              <span id="productSubmitText">Adicionar Produto</span>
            </button>
          </form>
        </div>

        <div>
          <h3>Produtos Cadastrados (<span id="adminProductCount">0</span>)</h3>
          <div id="adminProductsList" class="admin-products" style="margin-top:1rem;"></div>
        </div>
      </section>

      <!-- Usuários (apenas admin) -->
      <aside>
        <div class="admin-form">
          <h2>Gerenciar Usuários</h2>
          <p style="color:var(--text-light); margin-bottom:1rem;">Edite cargos de usuários (admin apenas)</p>

          <div id="usersContainer">
            <div id="usersList"></div>
          </div>
        </div>

        <div style="margin-top:1rem;">
          <h3>Ajuda rápida</h3>
          <p style="color:var(--text-light); font-size:0.95rem;">
            Para tornar alguém administrador/gerente escolha o papel e clique em salvar (o select salva automaticamente).
          </p>
        </div>
      </aside>
    </div>
  </main>

  <div id="notification" class="hidden"></div>

  <footer>
    <div class="container">
      <p>&copy; 2025 TechTrust. Todos os direitos reservados.</p>
    </div>
  </footer>

  <script src="js/storage.js"></script>

  <script>
    // Notification helper
    function notify(msg, type = "success", ttl = 3000) {
      let el = document.getElementById('notification');
      if (!el) {
        el = document.createElement('div');
        el.id = 'notification';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.className = '';
      el.classList.add(type === 'success' ? 'success' : 'error');
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), ttl);
    }

    // Ensure cart badge updates (calls storage.js)
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof updateCartCount === 'function') updateCartCount();
    });

    // Logout button in header (if present)
    function attachLogoutFallback() {
      const btn = document.getElementById('logoutBtn');
      if (btn) btn.onclick = async () => {
        await firebaseApi.signOut();
        localStorage.removeItem('ecommerce_current_user');
        window.location.href = 'login.html';
      };
    }

    // Route protection and initialization
    let editingProductId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // Wait for firebaseApi
      const wait = setInterval(async () => {
        if (window.firebaseApi) {
          clearInterval(wait);
          // Header dynamic
          await aplicarHeader();
          attachLogoutFallback();

          // Check current user & role
          const local = JSON.parse(localStorage.getItem('ecommerce_current_user') || 'null');
          if (!local || !local.uid) { window.location.href = 'login.html'; return; }
          const role = await firebaseApi.getRole(local.uid);
          if (role !== 'admin') {
            if (role === 'gerente') { window.location.href = 'gerente.html'; return; }
            window.location.href = 'unauthorized.html'; return;
          }

          // load data
          refreshCurrentUserInfo();
          loadProducts();
          loadUsers();
        }
      }, 80);
    });

    // Header function reused across pages (keeps cart icon)
    async function aplicarHeader() {
      const nav = document.getElementById('navMenu');
      const user = JSON.parse(localStorage.getItem('ecommerce_current_user') || 'null');
      if (!nav) return;
      if (!user) return;

      const role = await firebaseApi.getRole(user.uid) || 'usuario';

      nav.innerHTML = `
        <a href="home.html" class="btn btn-ghost">Home</a>
        <a href="produtos.html" class="btn btn-ghost">Produtos</a>
        ${ role === 'admin' ? `<a href="admin.html" class="btn btn-ghost">Admin</a>` : '' }
        ${ role === 'gerente' ? `<a href="admin.html" class="btn btn-ghost">Gerente</a>` : '' }

        <a href="carrinho.html" class="btn btn-primary cart-btn" style="position:relative;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.6 13.59a2 2 0 0 0 2 1.41h9.72a2 2 0 0 0 2-1.72L23 6H6"></path>
          </svg>
          <span class="cart-badge" style="display:none; position:absolute; top:-6px; right:-6px; background:var(--accent); color:white; border-radius:50%; padding:2px 6px; font-size:12px;">0</span>
        </a>

        <span style="color:var(--text-light); margin-right:1rem;">${user.email} (${role})</span>
        <button id="logoutBtn" class="btn btn-outline">Sair</button>
      `;
      if (typeof updateCartCount === 'function') updateCartCount();
    }

    async function refreshCurrentUserInfo() {
      const local = JSON.parse(localStorage.getItem('ecommerce_current_user') || 'null');
      if (!local) return;
      const role = await firebaseApi.getRole(local.uid);
      document.getElementById('currentUserInfo').textContent = `${local.email} ${role ? '('+role+')' : ''}`;
    }

    // ---------------- Products ----------------
    async function loadProducts() {
      const products = await firebaseApi.listProductsFirestore();
      const container = document.getElementById('adminProductsList');
      const count = document.getElementById('adminProductCount');
      count.textContent = products.length;
      if (!products.length) {
        container.innerHTML = `<div class="empty-state"><p style="color:var(--text-light)">Nenhum produto cadastrado</p></div>`;
        return;
      }

      container.innerHTML = products.map(p => `
        <div class="admin-product-card">
          <img src="${p.image || 'https://via.placeholder.com/100'}" alt="${p.name}" class="admin-product-image">
          <div class="admin-product-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <h3 style="margin:0;">${p.name}</h3>
                <div style="display:flex; gap:.5rem; margin-top:.25rem;">
                  <span class="product-category">${p.category || ''}</span>
                  ${p.featured ? '<span class="badge">Destaque</span>' : ''}
                </div>
              </div>
              <div class="admin-product-actions">
                <button class="btn btn-outline" onclick="startEditProduct('${p.id}')">Editar</button>
                <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">Excluir</button>
              </div>
            </div>
            <p style="color:var(--text-light); margin-top:.5rem;">${p.description || ''}</p>
            <div style="display:flex; gap:1rem; align-items:center; margin-top:.5rem;">
              <strong style="color:var(--primary)">R$ ${Number(p.price).toFixed(2)}</strong>
              <span style="color:var(--text-light)">Estoque: ${p.stock}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const product = {
        name: document.getElementById('p_name').value.trim(),
        description: document.getElementById('p_description').value.trim(),
        price: Number(document.getElementById('p_price').value),
        image: document.getElementById('p_image').value || 'https://via.placeholder.com/500',
        category: document.getElementById('p_category').value.trim(),
        stock: Number(document.getElementById('p_stock').value),
        featured: document.getElementById('p_featured').checked
      };

      try {
        if (editingProductId) {
          await firebaseApi.updateProductFirestore(editingProductId, product);
          notify('Produto atualizado com sucesso!', 'success');
        } else {
          await firebaseApi.addProductFirestore(product);
          notify('Produto adicionado com sucesso!', 'success');
        }
        resetProductForm();
        loadProducts();
      } catch (err) {
        console.error(err);
        notify('Erro ao salvar produto: ' + (err.message || err), 'error');
      }
    });

    function resetProductForm() {
      editingProductId = null;
      document.getElementById('productForm').reset();
      document.getElementById('productFormTitle').textContent = 'Adicionar Produto';
      document.getElementById('productSubmitText').textContent = 'Adicionar Produto';
      document.getElementById('cancelProductBtn').style.display = 'none';
    }

    async function startEditProduct(id) {
      const p = await firebaseApi.getProductByIdFirestore(id);
      if (!p) return;
      editingProductId = id;
      document.getElementById('p_name').value = p.name || '';
      document.getElementById('p_category').value = p.category || '';
      document.getElementById('p_price').value = p.price || 0;
      document.getElementById('p_stock').value = p.stock || 0;
      document.getElementById('p_image').value = p.image || '';
      document.getElementById('p_description').value = p.description || '';
      document.getElementById('p_featured').checked = !!p.featured;

      document.getElementById('productFormTitle').textContent = 'Editar Produto';
      document.getElementById('productSubmitText').textContent = 'Atualizar Produto';
      document.getElementById('cancelProductBtn').style.display = 'inline-block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteProduct(id) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) return;
      await firebaseApi.deleteProductFirestore(id);
      notify('Produto excluído', 'success');
      loadProducts();
    }

    // ---------------- Users ----------------
    async function loadUsers() {
      const users = await firebaseApi.listUserProfiles();
      const container = document.getElementById('usersList');
      if (!users.length) {
        container.innerHTML = `<div class="empty-state"><p style="color:var(--text-light)">Nenhum usuário encontrado</p></div>`;
        return;
      }

      container.innerHTML = users.map(u => `
        <div class="admin-product-card" style="align-items:center;">
          <div style="flex:1;">
            <h3 style="margin:0;">${u.displayName || '(sem nome)'}</h3>
            <p style="color:var(--text-light); margin:4px 0;">${u.email || ''}</p>
            <div style="display:flex; gap:0.5rem; align-items:center;">
              <label style="font-size:0.9rem; color:var(--text-light); margin-right:0.5rem;">Papel:</label>
              <select data-uid="${u.id}" style="padding:.5rem; border-radius:8px;">
                <option value="">— sem papel —</option>
                <option value="gerente">gerente</option>
                <option value="admin">admin</option>
              </select>
            </div>
          </div>
          <div>
            <button class="btn btn-outline" onclick="editUser('${u.id}')">Editar perfil</button>
          </div>
        </div>
      `).join('');

      for (const u of users) {
        const role = await firebaseApi.getRole(u.id);
        const sel = document.querySelector(`select[data-uid="${u.id}"]`);
        if (sel) sel.value = role || '';
        if (sel) {
          sel.onchange = async (e) => {
            const newRole = e.target.value;
            if (newRole) {
              await firebaseApi.setRole(u.id, newRole);
              notify('Papel atualizado: ' + newRole, 'success');
            } else {
              await firebaseApi.db.collection('roles').doc(u.id).delete();
              notify('Papel removido', 'success');
            }
            loadUsers();
          };
        }
      }
    }

    async function editUser(uid) {
      const profile = await firebaseApi.getUserProfile(uid);
      if (!profile) return;
      const newName = prompt('Nome do usuário:', profile.displayName || '');
      const newEmail = prompt('E-mail do usuário (apenas profile):', profile.email || '');
      if (newName === null) return;
      await firebaseApi.updateUserProfile(uid, { displayName: newName, email: newEmail });
      notify('Perfil atualizado', 'success');
      loadUsers();
    }
  </script>
</body>
</html>
