<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - TechTrust</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase + scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="auth.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container header-content">
      <a href="home.html" class="logo">TechTrust</a>
      <nav>
        <a href="home.html" class="btn btn-ghost">Home</a>
        <a href="produtos.html" class="btn btn-ghost">Produtos</a>
        <button id="logoutBtn" class="btn btn-ghost">Sair</button>
      </nav>
    </div>
  </header>

  <div class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="mb-4">
      <h1 style="font-size: 2.2rem; margin-bottom: 0.5rem;">Painel Administrativo</h1>
      <p style="color: var(--text-light);">Gerencie produtos e usuários</p>
      <div style="margin-top: 0.75rem;"><strong>Usuário:</strong> <span id="currentUserEmail">—</span></div>
    </div>

    <!-- Formulário de Produtos -->
    <div class="admin-form">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="formTitle">Adicionar Novo Produto</h2>
        <button class="btn btn-ghost" id="cancelBtn" style="display:none" onclick="resetForm()">Cancelar</button>
      </div>

      <form id="productForm" onsubmit="handleSubmit(event)">
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Nome do Produto *</label>
            <input type="text" id="name" required placeholder="Ex: Notebook Gamer">
          </div>

          <div class="form-group">
            <label for="category">Categoria *</label>
            <input type="text" id="category" required placeholder="Ex: Eletrônicos">
          </div>

          <div class="form-group">
            <label for="price">Preço (R$) *</label>
            <input type="number" id="price" step="0.01" required placeholder="0.00">
          </div>

          <div class="form-group">
            <label for="stock">Estoque *</label>
            <input type="number" id="stock" required placeholder="0">
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="image">URL da Imagem</label>
            <input type="text" id="image" placeholder="https://exemplo.com/imagem.jpg">
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="description">Descrição</label>
            <textarea id="description" placeholder="Descreva o produto..."></textarea>
          </div>

          <div class="form-group checkbox-group">
            <input type="checkbox" id="featured">
            <label for="featured">Produto em Destaque</label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
          <span id="submitText">Adicionar Produto</span>
        </button>
      </form>
    </div>

    <!-- Lista de Produtos -->
    <div style="margin-top: 2rem;">
      <h2>Produtos Cadastrados (<span id="productCount">0</span>)</h2>
      <div id="productsList" class="admin-products"></div>
    </div>

    <!-- Lista de Usuários -->
    <div style="margin-top: 2rem;">
      <h2>Usuários (<span id="usersCount">0</span>)</h2>
      <div id="usersList"></div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 TechTrust. Todos os direitos reservados.</p>
    </div>
  </footer>

  <script>
    let editingProductId = null;

    async function updateUIForUser(user) {
      if (user) {
        document.getElementById('currentUserEmail').textContent = user.email + (user.role ? ' (' + user.role + ')' : '');
      } else {
        document.getElementById('currentUserEmail').textContent = '—';
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await appAuth.handleSignOut();
      window.location.href = 'login.html';
    });

    // Protege a página — somente admin
    document.addEventListener('DOMContentLoaded', async () => {
      const ok = await appAuth.requireRole(['admin']);
      if (!ok) return;

      loadProducts();
      loadUsers();
    });

    // ---------- Products ----------
    async function loadProducts() {
      const products = await firebaseApi.listProductsFirestore();
      const container = document.getElementById('productsList');
      const count = document.getElementById('productCount');
      count.textContent = products.length;
      if (!products.length) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--text-light);">Nenhum produto cadastrado</p></div>`;
        return;
      }
      container.innerHTML = products.map(p => `
        <div class="admin-product-card">
          <img src="${p.image || 'https://via.placeholder.com/100'}" alt="${p.name}" class="admin-product-image">
          <div class="admin-product-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <h3>${p.name}</h3>
                <div style="display:flex; gap:.5rem;">
                  <span class="product-category">${p.category || ''}</span>
                  ${p.featured ? '<span class="badge">Destaque</span>' : ''}
                </div>
              </div>
              <div class="admin-product-actions">
                <button class="btn btn-outline" onclick="editProduct('${p.id}')">Editar</button>
                <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">Excluir</button>
              </div>
            </div>
            <p style="color: var(--text-light);">${p.description || ''}</p>
            <div style="display:flex; gap:1rem; align-items:center;">
              <strong style="color:var(--primary);">R$ ${Number(p.price).toFixed(2)}</strong>
              <span style="color:var(--text-light);">Estoque: ${p.stock}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const product = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: Number(document.getElementById('price').value),
        image: document.getElementById('image').value || 'https://via.placeholder.com/500',
        category: document.getElementById('category').value,
        stock: Number(document.getElementById('stock').value),
        featured: document.getElementById('featured').checked
      };

      if (editingProductId) {
        await firebaseApi.updateProductFirestore(editingProductId, product);
        showNotification('Produto atualizado com sucesso!', 'success');
      } else {
        await firebaseApi.addProductFirestore(product);
        showNotification('Produto adicionado com sucesso!', 'success');
      }

      resetForm();
      loadProducts();
    }

    function resetForm() {
      editingProductId = null;
      document.getElementById('productForm').reset();
      document.getElementById('formTitle').textContent = 'Adicionar Novo Produto';
      document.getElementById('submitText').textContent = 'Adicionar Produto';
      document.getElementById('cancelBtn').style.display = 'none';
    }

    async function editProduct(id) {
      const p = await firebaseApi.getProductByIdFirestore(id);
      if (!p) return;
      editingProductId = id;
      document.getElementById('name').value = p.name;
      document.getElementById('description').value = p.description || '';
      document.getElementById('price').value = p.price;
      document.getElementById('image').value = p.image || '';
      document.getElementById('category').value = p.category || '';
      document.getElementById('stock').value = p.stock || 0;
      document.getElementById('featured').checked = !!p.featured;

      document.getElementById('formTitle').textContent = 'Editar Produto';
      document.getElementById('submitText').textContent = 'Atualizar Produto';
      document.getElementById('cancelBtn').style.display = 'inline-block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteProduct(id) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) return;
      await firebaseApi.deleteProductFirestore(id);
      showNotification('Produto excluído', 'success');
      loadProducts();
    }

    // ---------- Users (profiles) ----------
    async function loadUsers() {
      const users = await firebaseApi.listUserProfiles();
      const usersList = document.getElementById('usersList');
      const count = document.getElementById('usersCount');
      count.textContent = users.length;
      if (!users.length) {
        usersList.innerHTML = `<div class="empty-state"><p style="color: var(--text-light);">Nenhum usuário encontrado</p></div>`;
        return;
      }

      usersList.innerHTML = users.map(u => `
        <div class="admin-product-card" style="align-items: center;">
          <div style="flex:1;">
            <h3 style="margin-bottom:.25rem;">${u.displayName || '(sem nome)'}</h3>
            <p style="color:var(--text-light); margin-bottom:.25rem;">${u.email || ''}</p>
            <div style="display:flex; gap:.5rem; align-items:center;">
              <label style="font-size:0.875rem;">Papel:</label>
              <select data-uid="${u.id}" onchange="changeUserRole(event)">
                <option value="">— sem papel —</option>
                <option value="gerente">gerente</option>
